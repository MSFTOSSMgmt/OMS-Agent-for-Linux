# Linux Squid Proxy 3.8 Log Monitoring Solution for Operations Management Suite
#
# Copy this file (squid.conf) to /etc/opt/microsoft/omsagent/conf/omsagent.d
# Grant the user omsagent read access to the squid log file (i.e. /var/log/squid/access.log). 
# Assuming the log file is owned by the group squid, you can add the user omsagent to the squid group : sudo usermod -a -G squid omsagent

#Confirm that no errors are reported in the omsagent log:
#tail /var/opt/microsoft/omsagent/log/omsagent.log


<source>
  type tail
  #type sudo_tail
  path /var/log/squid/access.log
  pos_file /var/opt/microsoft/omsagent/state/var_log_squidv3_log.pos
  #read_from_head true
  run_interval 5s
  tag oms.api.squid
  format /(?<EventTime>\d+)\.\d{3}\s+-?\d+(?<SourceIP>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?<cache>\w+)\/(?<httpresponse>\d+)(?<size>\d+)(?<uri>.+)(?<user>\S+)(?<method>[A-Z]+\/\S+).+/
  #types querytime_ms:float  
</source>

<filter oms.api.squid>
  type record_transformer
  enable_ruby
  <record>
    ResourceName Squid
    Computer ${OMS::Common.get_hostname}
    ResourceId ${OMS::Common.get_hostname}
  </record>
</filter>

<match oms.api.squid.**>
  type out_oms_api
  log_level info

  buffer_chunk_limit 5m
  buffer_type file
  buffer_path /var/opt/microsoft/omsagent/state/var_log_squidv3_log*.buffer
  buffer_queue_limit 10
  flush_interval 20s
  retry_limit 10
  retry_wait 5s
  max_retry_wait 5m
  compress true

</match>

